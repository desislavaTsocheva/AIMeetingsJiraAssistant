@page "/callback"
@using JiraAiTool.Services
@using JiraAiTool.Models
@using Microsoft.AspNetCore.WebUtilities
@using Microsoft.EntityFrameworkCore
@using System.Net.Http.Headers
@inject NavigationManager Nav
@inject IHttpClientFactory ClientFactory
@inject UserSession Session
@inject AppDbContext Db
@inject AtlassianAuthService AuthService

<div class="callback-container">
    @if (isProcessing)
    {
        <div class="loader"></div>
        <p>Connecting your Jira account...</p>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <p class="error">@errorMessage</p>
        <button class="btn btn-primary" @onclick='() => Nav.NavigateTo("/login")'>Try Again</button>
    }
</div>

@code {
    private bool isProcessing = true;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        var uri = Nav.ToAbsoluteUri(Nav.Uri);
        var query = QueryHelpers.ParseQuery(uri.Query);

        if (query.TryGetValue("code", out var code))
        {
            await ExchangeCodeForToken(code!);
        }
        else
        {
            errorMessage = "No authorization code received from Atlassian.";
            isProcessing = false;
        }
    }

    private async Task ExchangeCodeForToken(string code)
    {
        string? accountId = null;
        string? email = null;
        string? siteUrl = null;

        try
        {
            var tokenData = await AuthService.ExchangeCodeAsync(code);
            var client = ClientFactory.CreateClient();
            client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", tokenData.access_token);

            var sites = await client.GetFromJsonAsync<List<AtlassianSite>>("https://api.atlassian.com/oauth/token/accessible-resources");
            var me = await client.GetFromJsonAsync<AtlassianMe>("https://api.atlassian.com/me");

            if (sites == null || !sites.Any() || me == null) throw new Exception("Atlassian data retrieval failed");

            var site = sites.First();
            accountId = me.account_id;
            email = me.email ?? "";
            siteUrl = site.url;

            var user = await Db.Users.FirstOrDefaultAsync(u => u.JiraAccountId == accountId);
            if (user == null)
            {
                user = new User { JiraAccountId = accountId, CreatedAt = DateTime.UtcNow, Email = email, ApiToken = "" };
                Db.Users.Add(user);
            }
            user.BaseUrl = siteUrl;
            user.Email = email;
            await Db.SaveChangesAsync();

            Session.JiraAccountId = accountId;
            Session.BaseUrl = siteUrl;
            Session.Email = email;
            isProcessing = false;
        }
        catch (Exception ex)
        {
            errorMessage = $"Authentication failed: {ex.Message}";
            isProcessing = false;
            return;
        }

        Nav.NavigateTo($"/setup-qr-code?email={Uri.EscapeDataString(email ?? "")}&url={Uri.EscapeDataString(siteUrl ?? "")}&accountId={accountId}");
    }

    public record AtlassianSite(string id, string url);
    public record AtlassianMe(string account_id, string? email);
}