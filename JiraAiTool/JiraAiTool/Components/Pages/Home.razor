@page "/home"
@using JiraAiTool.Models
@using JiraAiTool.Services
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Forms
@inject JiraService Jira;
@inject IServiceScopeFactory ServiceScopeFactory
@inject AppDbContext DbContext
@rendermode InteractiveServer
@inject UserSession Session
@inject AppDbContext Db
@inject IJSRuntime JS


<div class="dashboard-container">
    <header class="dashboard-header">
        <div>
            <h1>SyncUp</h1>
            <p class="subtitle">Transform meeting transcripts into actionable Jira tasks in seconds.</p>
        </div>
    </header>

    <div class="main-grid">
        <div class="glass-card input-section">
            <div class="card-header">
                <i class="bi bi-pencil-square"></i>
                <h5>Meeting Transcript</h5>
            </div>
            <textarea class="custom-textarea"
                      placeholder="Paste your meeting notes or transcript here..."
                      @bind="meetingText"
                      disabled="@isProcessing"></textarea>

            <div class="divider"><span>OR</span></div>

            <div class="file-upload-zone">
                <i class="bi bi-cloud-arrow-up"></i>
                <p>Upload meeting audio or documents</p>
                <InputFile OnChange="OnFileSelected" class="file-input" accept=".pdf,.docx,.mp3,.wav" disabled="@isProcessing" />
                @if (uploadedFile != null)
                {
                    <div class="file-badge">
                        <i class="bi bi-file-earmark-check"></i> @uploadedFile.Name
                    </div>
                }
            </div>

            <button class="btn-primary-glow" @onclick="Analyze" disabled="@(isProcessing || (string.IsNullOrEmpty(meetingText) && uploadedFile == null))">
                @if (isProcessing)
                {
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    <span>Analyzing with AI...</span>
                }
                else
                {
                    <i class="bi bi-magic"></i>
                    <span>Generate Jira Tasks</span>
                }
            </button>
        </div>
    </div>
</div>

@code {
    private string meetingText = "";
    private bool isProcessing = false;

    private bool isFileInput = false;
    private IBrowserFile? uploadedFile;

    private List<TaskItem> pendingTasks = new();
    private List<JiraService.JiraUser> jiraUsers = new();
    private List<JiraService.JiraProject> availableJiraProjects = new();
    private string globalSelectedProjectKey = "";

    protected override async Task OnInitializedAsync()
    {
        if (!Session.IsReady)
        {
            var savedUser = await Db.Users.OrderByDescending(u => u.CreatedAt).FirstOrDefaultAsync();
            if (savedUser != null)
            {
                Session.Email = savedUser.Email;
                Session.ApiToken = savedUser.ApiToken;
                Session.BaseUrl = savedUser.BaseUrl;
                Session.JiraAccountId = savedUser.JiraAccountId;
            }
        }
    }

    private void OnFileSelected(InputFileChangeEventArgs e)
    {
        uploadedFile = e.File;
        isFileInput = true;
        meetingText = "";
    }

    private async Task Analyze()
    {
        if (isProcessing) return;

        if (isFileInput && uploadedFile != null)
            await AnalyzeFromFile();
        else if (!string.IsNullOrWhiteSpace(meetingText))
            await AnalyzeFromText();
    }

    private async Task AnalyzeFromText()
    {
        isProcessing = true;

        using var scope = ServiceScopeFactory.CreateScope();
        var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();
        var ai = scope.ServiceProvider.GetRequiredService<OllamaService>();
        var jiraUsers = await Jira.GetAllUsersAsync();

        var doc = new MeetingDocument
        {
            Title = "Manual Text",
            RawContent = meetingText
        };

        db.Documents.Add(doc);
        await db.SaveChangesAsync();

        var tasks = await ai.ExtractTasksAsync(meetingText, jiraUsers);

        foreach (var t in tasks)
        {
            t.MeetingDocumentId = doc.Id;

            if (!string.IsNullOrEmpty(t.AssigneeName))
            {
                var match = jiraUsers.FirstOrDefault(u =>
                    u.displayName.Contains(t.AssigneeName, StringComparison.OrdinalIgnoreCase));

                if (match != null)
                {
                    t.JiraAccountId = match.accountId;
                    t.AssigneeName = match.displayName;
                }
            }

            db.Tasks.Add(t);
        }

        await db.SaveChangesAsync();

        int count = tasks.Count;
        await JS.InvokeVoidAsync("prettyAlert.fire", new
        {
            icon = "success",
            title = "Analysis Complete",
            text = $"AI extracted {tasks.Count} Jira tasks",
            confirmButtonText = "Okay"
        });
        meetingText = "";
        await LoadPendingTasks();
        isProcessing = false;
    }

    private async Task AnalyzeFromFile()
    {
        if (uploadedFile == null) return;

        isProcessing = true;
        StateHasChanged();

        try
        {
            using var ms = new MemoryStream();
            await uploadedFile.OpenReadStream(20 * 1024 * 1024).CopyToAsync(ms);

            using var scope = ServiceScopeFactory.CreateScope();
            var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();
            var ai = scope.ServiceProvider.GetRequiredService<OllamaService>();
            var fileService = scope.ServiceProvider.GetRequiredService<FileProcessingService>();

            string fileName = uploadedFile.Name;
            string extractedText = "";

            if (fileName.EndsWith(".pdf", StringComparison.OrdinalIgnoreCase))
            {
                ms.Position = 0;
                extractedText = await fileService.ExtractTextFromPdf(ms);
            }
            else if (fileName.EndsWith(".docx", StringComparison.OrdinalIgnoreCase))
            {
                ms.Position = 0;
                extractedText = fileService.ExtractTextFromWord(ms);
            }
            else
            {
                ms.Position = 0;
                extractedText = await fileService.TranscribeAudio(ms);
            }

            Console.WriteLine($"Extracted text length: {extractedText.Length}");
            if (extractedText.Length > 0)
                Console.WriteLine($"Text preview: {extractedText.Substring(0, Math.Min(200, extractedText.Length))}");

            if (string.IsNullOrWhiteSpace(extractedText))
            {
                Console.WriteLine("No text extracted from the file");
                return;
            }

            var doc = new MeetingDocument { Title = $"File: {fileName}", RawContent = extractedText };
            db.Documents.Add(doc);
            await db.SaveChangesAsync();
            var jiraUsers = await Jira.GetAllUsersAsync();
            var tasks = await ai.ExtractTasksAsync(extractedText, jiraUsers);
            foreach (var t in tasks)
            {
                t.MeetingDocumentId = doc.Id;
                t.IsApproved = false;

                var match = jiraUsers.FirstOrDefault(u =>
                u.displayName.Equals(t.AssigneeName, StringComparison.OrdinalIgnoreCase) ||
                t.AssigneeName.Contains(u.displayName, StringComparison.OrdinalIgnoreCase) ||
                u.displayName.Contains(t.AssigneeName, StringComparison.OrdinalIgnoreCase));

                if (match != null)
                {
                    t.JiraAccountId = match.accountId;
                }

                db.Tasks.Add(t);
            }

            await db.SaveChangesAsync();
            await LoadPendingTasks();

            int count = tasks.Count;

            await JS.InvokeVoidAsync("prettyAlert.fire", new
            {
                icon = "success",
                title = "Analysis Complete",
                text = $"AI extracted {tasks.Count} Jira tasks",
                confirmButtonText = "Okay"
            });
            uploadedFile = null;
            isFileInput = false;
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("prettyAlert.fire", new
            {
                icon = "error",
                title = "Something went wrong!",
                text = "File error occure.",
                confirmButtonText = "OK"
            });


            Console.WriteLine($"Error processing file: {ex.Message}");
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }

    private async Task LoadPendingTasks()
    {
        pendingTasks = await DbContext.Tasks
            .Where(t => !t.IsApproved)
            .OrderByDescending(t => t.CreatedAt)
            .ToListAsync();

        StateHasChanged();
    }
}
