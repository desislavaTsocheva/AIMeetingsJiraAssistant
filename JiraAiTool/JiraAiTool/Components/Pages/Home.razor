@page "/"
@using JiraAiTool.Models
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Forms
@inject JiraService Jira;
@inject IServiceScopeFactory ServiceScopeFactory
@inject AppDbContext DbContext
@rendermode InteractiveServer

<div class="container mt-4">
    <h3>AI Meeting Assistant</h3>

    <div class="card p-3 mb-3">
        <h5>Meeting Text</h5>
        <textarea class="form-control" rows="6"
                  @bind="meetingText"
                  placeholder="Paste meeting text here..."
                  disabled="@isFileInput">
        </textarea>
    </div>

    <div class="card p-3 mb-3">
        <h5>Upload File</h5>
        <InputFile OnChange="OnFileSelected"
                   accept=".pdf,.docx,.mp3,.wav"
                   class="form-control" />
    </div>

    <button class="btn btn-primary"
            disabled="@isProcessing"
            @onclick="Analyze">
        @if (isProcessing)
        {
            <span class="spinner-border spinner-border-sm"></span>
            <span class="ms-2">Processing...</span>
        }
        else
        {
            <span>Analyze</span>
        }
    </button>

    @if (pendingTasks != null && pendingTasks.Any())
        {
            <div class="col-md-12">
                <div class="card shadow-sm border-warning">
                    <div class="card-header bg-warning text-dark">
                        <strong>Pending Approval</strong>
                    </div>
                    <div class="card-body">
                        <table class="table table-striped align-middle">
                            <thead>
                                <tr>
                                    <th>Task Description</th>
                                    <th>Assignee</th>
                                    <th>Deadline</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var task in pendingTasks)
                                {
                                    <tr>
                                        <td><input @bind="task.Description" class="form-control" /></td>
                                        <td><input @bind="task.AssigneeName" class="form-control" /></td>
                                        <td><input type="date" @bind="task.Deadline" class="form-control" /></td>
                                        <td>
                                            <button class="btn btn-success btn-sm" @onclick="() => Approve(task)">Approve</button>
                                            <button class="btn btn-outline-danger btn-sm" @onclick="() => Delete(task)">Delete</button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        }
    </div>

@code {

    private string meetingText = "";
    private bool isProcessing = false;

    private bool isFileInput = false;
    private IBrowserFile? uploadedFile;

    private List<TaskItem> pendingTasks = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadPendingTasks();
    }

    private void OnFileSelected(InputFileChangeEventArgs e)
    {
        uploadedFile = e.File;
        isFileInput = true;
        meetingText = "";
    }

    private async Task Analyze()
    {
        if (isProcessing) return;

        if (isFileInput && uploadedFile != null)
            await AnalyzeFromFile();
        else if (!string.IsNullOrWhiteSpace(meetingText))
            await AnalyzeFromText();
    }

    private async Task AnalyzeFromText()
    {
        isProcessing = true;

        using var scope = ServiceScopeFactory.CreateScope();
        var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();
        var ai = scope.ServiceProvider.GetRequiredService<OllamaService>();

        var doc = new MeetingDocument
        {
            Title = "Manual Text",
            RawContent = meetingText
        };

        db.Documents.Add(doc);
        await db.SaveChangesAsync();

        var tasks = await ai.ExtractTasksAsync(meetingText);

        foreach (var t in tasks)
        {
            t.MeetingDocumentId = doc.Id;
            db.Tasks.Add(t);
        }

        await db.SaveChangesAsync();

        meetingText = "";
        await LoadPendingTasks();

        isProcessing = false;
    }


    private async Task AnalyzeFromFile()
    {
        isProcessing = true;
        StateHasChanged();

        byte[] fileBytes;
        string fileName;

        using (var stream = uploadedFile!.OpenReadStream(20 * 1024 * 1024))
        using (var ms = new MemoryStream())
        {
            await stream.CopyToAsync(ms);
            fileBytes = ms.ToArray();
            fileName = uploadedFile.Name;
        }

        using var scope = ServiceScopeFactory.CreateScope();
        var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();
        var ai = scope.ServiceProvider.GetRequiredService<OllamaService>();
        var fileService = scope.ServiceProvider.GetRequiredService<FileProcessingService>();

        using var ms2 = new MemoryStream(fileBytes);

        string text =
            fileName.EndsWith(".pdf")
                ? await fileService.ExtractTextFromPdf(ms2)
                : fileName.EndsWith(".docx")
                    ? fileService.ExtractTextFromWord(ms2)
                    : await fileService.TranscribeAudio(ms2);

        var doc = new MeetingDocument
        {
            Title = $"File: {fileName}",
            RawContent = text
        };

        db.Documents.Add(doc);
        await db.SaveChangesAsync();

        var tasks = await ai.ExtractTasksAsync(text);

        foreach (var t in tasks)
        {
            t.MeetingDocumentId = doc.Id;
            t.IsApproved = false;
            db.Tasks.Add(t);
        }

        await db.SaveChangesAsync();

        await LoadPendingTasks();

        isProcessing = false;
        isFileInput = false;
        uploadedFile = null;

        StateHasChanged();
    }


    private async Task LoadPendingTasks()
    {
        pendingTasks = await DbContext.Tasks
            .Where(t => !t.IsApproved)
            .OrderByDescending(t => t.CreatedAt)
            .ToListAsync();

        StateHasChanged();
    }

    private async Task Approve(TaskItem task)
    {
        var summary = task.Description.Length > 80
            ? task.Description.Substring(0, 77) + "..."
            : task.Description;

        var success = await Jira.CreateIssueAsync(
            summary,
            task.Description,
            task.CreatedAt,  
            task.Deadline     
        );

        if (!success)
        {
            Console.WriteLine("❌ Jira rejected issue");
            return;
        }

        task.IsApproved = true;
        await DbContext.SaveChangesAsync();
        await LoadPendingTasks();
    }


    private async Task Delete(TaskItem task)
    {
        DbContext.Tasks.Remove(task);
        await DbContext.SaveChangesAsync();
        await LoadPendingTasks();
    }
}
