@page "/"
@using JiraAiTool.Components.Layout
@inject NavigationManager NavigationManager
@rendermode InteractiveServer
@layout AuthLayout
@inject IConfiguration Configuration

<div class="login-container">
    <div class="login-card">
        <div class="icon-header">
            <div class="ai-badge">AI</div>
        </div>

        <h1>Jira AI Assistant</h1>
        <p>Log in to sync your tasks and start optimizing your workflow.</p>
        <button class="jira-btn" @onclick="RedirectToJira">
            Continue with Atlassian
        </button>

        <p class="footer-text">Securely powered by Atlassian OAuth 2.0</p>
    </div>
</div>

@code {
    private void RedirectToJira()
    {
        var clientId = Configuration["Atlassian:ClientId"];
        var redirectUri = "https://localhost:44391/callback";
        var scopeList = "read:me read:jira-user read:jira-work write:jira-work offline_access";
        var scopes = Uri.EscapeDataString(scopeList);
        var state = Guid.NewGuid().ToString(); 

        var authUrl = $"https://auth.atlassian.com/authorize?" +
                      $"audience=api.atlassian.com&" +
                      $"client_id={clientId}&" +
                      $"scope={scopes}&" +
                      $"redirect_uri={Uri.EscapeDataString(redirectUri)}&" +
                      $"state={state}&" +
                      $"response_type=code&" +
                      $"prompt=consent";

        NavigationManager.NavigateTo(authUrl);
    }
}
