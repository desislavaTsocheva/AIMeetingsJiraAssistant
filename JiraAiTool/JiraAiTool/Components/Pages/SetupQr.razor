@page "/setup-qr-code"
@using JiraAiTool.Models
@using JiraAiTool.Services
@using Microsoft.AspNetCore.WebUtilities
@using Microsoft.EntityFrameworkCore
@using QRCoder
@rendermode InteractiveServer
@inject UserSession Session
@inject AppDbContext Db
@inject NavigationManager Nav
@inject AtlassianAuthService AuthService

<div style="max-width: 400px; margin: auto; text-align: center; padding: 2rem;">
    <h2>Step 2: Jira Security</h2>

    @if (!string.IsNullOrEmpty(qrCodeImageSrc))
    {
        <img src="@qrCodeImageSrc" style="width: 200px; margin-bottom: 1rem;" />
    }

    <div style="text-align: left; margin-top: 1.5rem;">
        <label>Jira Login Email</label>
        <input type="email" @bind="email" class="form-control" style="width: 100%; margin-bottom: 1rem;" />

        <label>API Token</label>
        <input type="password" @bind="apiToken" class="form-control" style="width: 100%; margin-bottom: 1rem;" />

        <button @onclick="Save" class="btn btn-primary" style="width: 100%; padding: 0.8rem;">
            Complete Setup
        </button>
    </div>

    @if (!string.IsNullOrEmpty(error))
    {
        <div class="alert alert-danger" style="margin-top: 1rem;">@error</div>
    }
</div>

@code {
    string apiToken = "";
    string email = "";
    string? error;
    string qrCodeImageSrc = "";

    protected override void OnInitialized()
    {
        email = GetQueryParam("email") ?? Session.Email ?? "";
        GenerateQrCode("https://id.atlassian.com/manage-profile/security/api-tokens");
    }

    private string? GetQueryParam(string key)
    {
        var uri = Nav.ToAbsoluteUri(Nav.Uri);
        var query = QueryHelpers.ParseQuery(uri.Query);
        return query.TryGetValue(key, out var value) ? value.ToString() : null;
    }

    async Task Save()
    {
        try
        {
            error = null;
            if (string.IsNullOrEmpty(apiToken) || string.IsNullOrEmpty(email))
            {
                error = "Please fill in all fields.";
                return;
            }

            var accountId = GetQueryParam("accountId") ?? Session.JiraAccountId;
            if (string.IsNullOrEmpty(accountId))
            {
                error = "No Account ID found. Please go back to login.";
                return;
            }

            var user = await Db.Users.FirstOrDefaultAsync(u => u.JiraAccountId == accountId);
            if (user == null)
            {
                error = "User not found in database. Try logging in again.";
                return;
            }

            user.ApiToken = AuthService.ProtectToken(apiToken);
            user.Email = email;

            var urlBaseUrl = GetQueryParam("url");
            if (!string.IsNullOrEmpty(urlBaseUrl)) user.BaseUrl = urlBaseUrl;

            await Db.SaveChangesAsync();

            Session.ApiToken = user.ApiToken;
            Session.Email = user.Email;
            Session.BaseUrl = user.BaseUrl;
            Session.JiraAccountId = user.JiraAccountId;

            Nav.NavigateTo("/home");
        }
        catch (Exception ex)
        {
            error = $"Save error: {ex.Message}";
            Console.WriteLine($"Critical Save Error: {ex}");
        }
    }

    private void GenerateQrCode(string url)
    {
        try
        {
            using QRCodeGenerator qrGenerator = new QRCodeGenerator();
            using QRCodeData qrCodeData = qrGenerator.CreateQrCode(url, QRCodeGenerator.ECCLevel.Q);
            using PngByteQRCode qrCode = new PngByteQRCode(qrCodeData);
            qrCodeImageSrc = $"data:image/png;base64,{Convert.ToBase64String(qrCode.GetGraphic(20))}";
        }
        catch { }
    }
}