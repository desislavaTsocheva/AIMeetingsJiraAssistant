@page "/setup-qr-code"
@using JiraAiTool.Models
@using JiraAiTool.Services
@using Microsoft.AspNetCore.WebUtilities
@using Microsoft.EntityFrameworkCore
@using QRCoder
@rendermode InteractiveServer
@inject UserSession Session
@inject AppDbContext Db
@inject NavigationManager Nav

<div style="max-width: 400px; margin: auto; text-align: center; padding: 2rem;">
    <h2>Step 2: Jira Security</h2>
    <p>To access your tasks, we need a Jira API Token.</p>

    @if (!string.IsNullOrEmpty(qrCodeImageSrc))
    {
        <img src="@qrCodeImageSrc" style="width: 200px; margin-bottom: 1rem;" />
        <br />
        <a href="https://id.atlassian.com/manage-profile/security/api-tokens" target="_blank">Click here to create a token</a>
    }

    <div style="text-align: left; margin-top: 1.5rem;">
        <label><b>Jira Login Email</b></label>
        <input type="email" @bind="email" class="form-control" style="width: 100%; margin-bottom: 1rem;" placeholder="you@company.com" />

        <label><b>API Token</b></label>
        <input type="password" @bind="apiToken" class="form-control" style="width: 100%; margin-bottom: 1rem;" placeholder="ATATT..." />

        <button @onclick="Save" class="btn btn-primary" style="width: 100%; padding: 0.8rem;">Complete Setup</button>
    </div>

    @if (!string.IsNullOrEmpty(error))
    {
        <div style="color: red; margin-top: 1rem;">@error</div>
    }
</div>

@code {
    string apiToken = "";
    string email = "";
    string? error;
    string qrCodeImageSrc = "";

    protected override void OnInitialized()
    {
        email = GetQueryParam("email") ?? Session.Email ?? "";

        GenerateQrCode("https://id.atlassian.com/manage-profile/security/api-tokens");
    }

    private string? GetQueryParam(string key)
    {
        var uri = Nav.ToAbsoluteUri(Nav.Uri);
        return QueryHelpers.ParseQuery(uri.Query).TryGetValue(key, out var value) ? value.ToString() : null;
    }

    async Task Save()
    {
        if (string.IsNullOrEmpty(apiToken) || string.IsNullOrEmpty(email))
        {
            error = "Both Email and Token are required.";
            return;
        }

        var accountId = GetQueryParam("accountId") ?? Session.JiraAccountId;

        if (string.IsNullOrEmpty(accountId))
        {
            error = "User identity not found. Please log in again via the main page.";
            return;
        }

        try
        {
            var user = await Db.Users.FirstOrDefaultAsync(u => u.JiraAccountId == accountId);

            if (user == null)
            {
                error = "Session expired. No matching user record found.";
                return;
            }

            user.ApiToken = apiToken;
            user.Email = email; 

            var urlBaseUrl = GetQueryParam("url");
            if (!string.IsNullOrEmpty(urlBaseUrl)) user.BaseUrl = urlBaseUrl;

            await Db.SaveChangesAsync();

            Session.ApiToken = user.ApiToken;
            Session.Email = user.Email;
            Session.BaseUrl = user.BaseUrl;
            Session.JiraAccountId = user.JiraAccountId;

            Nav.NavigateTo("/home");
        }
        catch (Exception ex)
        {
            error = $"Save failed: {ex.Message}";
        }
    }

    private void GenerateQrCode(string url)
    {
        try
        {
            using QRCodeGenerator qrGenerator = new QRCodeGenerator();
            using QRCodeData qrCodeData = qrGenerator.CreateQrCode(url, QRCodeGenerator.ECCLevel.Q);
            using PngByteQRCode qrCode = new PngByteQRCode(qrCodeData);
            byte[] qrAsBytes = qrCode.GetGraphic(20);
            qrCodeImageSrc = $"data:image/png;base64,{Convert.ToBase64String(qrAsBytes)}";
        }
        catch { }
    }
}