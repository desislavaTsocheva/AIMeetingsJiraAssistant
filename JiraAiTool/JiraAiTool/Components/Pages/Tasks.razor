@page "/tasks"
@using JiraAiTool.Models
@using JiraAiTool.Services
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Forms
@inject JiraService Jira;
@inject IServiceScopeFactory ServiceScopeFactory
@inject AppDbContext DbContext
@inject UserSession Session
@inject NavigationManager NavigationManager
@rendermode InteractiveServer
@inject IJSRuntime JS
@inject IConfiguration Configuration


<div class="filter-bar card" style="margin-bottom: 20px; padding: 15px; display: flex; align-items: center; gap: 15px;">
    <i class="oi oi-filter"></i>
    <strong>Filter by Project/Document:</strong>

    <select class="modern-input" @onchange="OnProjectFilterChanged" style="width: 300px;">
        <option value="0">--- All Documents ---</option>
        @foreach (var doc in availableDocuments)
        {
            <option value="@doc.Id">@doc.Title (@doc.UploadedAt.ToShortDateString())</option>
        }
    </select>

    <span class="badge bg-primary">Total: @filteredTasks.Count</span>
</div>


@if (filteredTasks != null && filteredTasks.Any())
{
    <div class="card full-width">
        <h5>Pending Task Approval</h5>


        @if (filteredTasks != null && filteredTasks.Any())
        {
            <div class="tasks-grid">
                @foreach (var task in filteredTasks)
                {
                    @if (!task.IsApproved)
                    {
                        <div class="task-card shadow-sm">
                            <div class="task-card-header">
                                <input class="title-input" @bind="task.Title" placeholder="Task Title..." />

                                <select class="priority-select priority-@task.Priority" @bind="task.Priority">
                                    <option value="High">High</option>
                                    <option value="Medium">Medium</option>
                                    <option value="Low">Low</option>
                                </select>
                            </div>

                            <div class="task-card-body">
                                <div class="field-group">
                                    <label class="field-label">Description</label>
                                    <div class="voice-input-wrapper">
                                        <textarea class="desc-textarea" @bind="task.Description" rows="3"></textarea>
                                        <button type="button" class="mic-overlay-btn" @onclick="() => ToggleVoice(task)">
                                            @if (isListening && currentlyEditingTask == task)
                                            {
                                                <span class="rec-dot">● REC</span>
                                            }
                                            else
                                            {
                                                <span class="mic-icon">🎤</span>
                                            }
                                        </button>
                                    </div>
                                </div>

                                <div class="task-meta-grid">
                                    <div class="field-group">
                                        <label class="field-label">Assign To</label>
                                        <select class="modern-select" @onchange="(e) => OnAssigneeChanged(task, e.Value?.ToString())">
                                            <option value="">-- User --</option>
                                            @foreach (var user in jiraUsers)
                                            {
                                                <option value="@user.accountId" selected="@(task.JiraAccountId == user.accountId)">
                                                    @user.displayName
                                                </option>
                                            }
                                        </select>
                                    </div>

                                    <div class="field-group">
                                        <label class="field-label">Jira Project</label>
                                        <select class="modern-select" @bind="task.ProjectId">
                                            @foreach (var proj in availableJiraProjects)
                                            {
                                                <option value="@proj.key">@proj.name (@proj.key)</option>
                                            }
                                        </select>
                                    </div>

                                    <div class="field-group">
                                        <label class="field-label">Due Date</label>
                                        <input type="date" class="modern-date-input" @bind="task.Deadline" />
                                    </div>
                                </div>
                            </div>

                            <div class="task-card-actions">
                                <button class="action-btn btn-approve" @onclick="() => Approve(task)" title="Sync to Jira">
                                    <i class="oi oi-check"></i> Approve
                                </button>
                                <button class="action-btn btn-details" @onclick="() => ViewDetails(task.Id)" title="View Info">
                                    <i class="oi oi-pencil"></i> Details
                                </button>
                                <button class="action-btn btn-delete" @onclick="() => Delete(task)" title="Discard Task">
                                    <i class="oi oi-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    }
                }
            </div>
        }
    </div>
}

@code {

    private bool isFileInput = false;
    private IBrowserFile? uploadedFile;

    private List<TaskItem> pendingTasks = new();
    private List<JiraService.JiraUser> jiraUsers = new();


    private List<TaskItem> allTasks = new();
    private List<MeetingDocument> availableDocuments = new();
    private int selectedDocId = 0;


    private TaskItem? currentlyEditingTask;

    private bool isListening = false;


    private List<JiraService.JiraProject> availableJiraProjects = new();
    private string globalSelectedProjectKey = "";

    protected override async Task OnInitializedAsync()
    {
        bool userLoaded = await Session.LoadUserFromDb(DbContext);

        if (userLoaded && !string.IsNullOrEmpty(Session.BaseUrl))
        {
            jiraUsers = await Jira.GetAllUsersAsync();

            availableJiraProjects = await Jira.GetProjectsAsync();
            if (availableJiraProjects.Any())
            {
                globalSelectedProjectKey = availableJiraProjects.First().key;
            }
            await LoadData();
        }
        else
        {
            NavigationManager.NavigateTo("/");
        }
    }

    private async Task ToggleVoice(TaskItem task)
    {
        if (isListening)
        {
            isListening = false;
            await JS.InvokeVoidAsync("speechToText.stopRecognition");
        }
        else
        {
            task.Description = "";
            currentlyEditingTask = task;
            isListening = true;
            var dotNetHelper = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("speechToText.startRecognition", dotNetHelper);
        }
        StateHasChanged();
    }

    [JSInvokable]
    public void OnVoiceResult(string transcript)
    {
        if (currentlyEditingTask != null)
        {
            currentlyEditingTask.Description = (currentlyEditingTask.Description + " " + transcript).Trim();
            StateHasChanged();
        }
    }

    [JSInvokable]
    public void OnVoiceEnd()
    {
        isListening = false;
        StateHasChanged();
    }

    private List<TaskItem> filteredTasks => selectedDocId == 0
        ? allTasks
        : allTasks.Where(t => t.MeetingDocumentId == selectedDocId).ToList();

    private void ViewDetails(int taskId)
    {
        NavigationManager.NavigateTo($"/Details/{taskId}");
    }

    private async Task LoadData()
    {
        using var scope = ServiceScopeFactory.CreateScope();
        var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();

        allTasks = await db.Tasks
            .Include(t => t.Document)
            .Where(t => !t.IsApproved)
            .OrderByDescending(t => t.CreatedAt)
            .ToListAsync();

        availableDocuments = allTasks
            .Select(t => t.Document)
            .Where(d => d != null)
            .DistinctBy(d => d.Id)
            .ToList()!;
    }

    private void OnProjectFilterChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int id))
        {
            selectedDocId = id;
        }
    }

    private void OnAssigneeChanged(TaskItem task, string? accountId)
    {
        if (string.IsNullOrEmpty(accountId))
            return;

        var user = jiraUsers.FirstOrDefault(u => u.accountId == accountId);

        task.JiraAccountId = accountId;
        task.AssigneeName = user?.displayName;
    }

    private void OnFileSelected(InputFileChangeEventArgs e)
    {
        uploadedFile = e.File;
        isFileInput = true;
    }

    private async Task LoadPendingTasks()
    {
        pendingTasks = await DbContext.Tasks
            .Where(t => !t.IsApproved)
            .OrderByDescending(t => t.CreatedAt)
            .ToListAsync();

        StateHasChanged();
    }

    private async Task Approve(TaskItem task)
    {
        string? accountId = task.JiraAccountId;
        string projectToUse = !string.IsNullOrEmpty(task.ProjectId)
                          ? task.ProjectId
                          : Configuration["JiraSettings:ProjectKey"];

        if (accountId == null && !string.IsNullOrWhiteSpace(task.AssigneeName))
        {
            accountId = await Jira.FindUserAccountIdAsync(task.AssigneeName);
            task.JiraAccountId = accountId;
        }

        var summary = task.Description.Length > 80
            ? task.Description.Substring(0, 77) + "..."
            : task.Description;

        var success = await Jira.CreateIssueAsync(
            projectToUse,
            summary,
            task.Title,
            task.Description,
            task.CreatedAt,
            task.Deadline,
            task.Priority,
            accountId
        );

        if (!success)
            return;

        task.IsApproved = true;
        await DbContext.SaveChangesAsync();
        await LoadPendingTasks();
    }

    private async Task Delete(TaskItem task)
    {
        DbContext.Tasks.Remove(task);
        await DbContext.SaveChangesAsync();
        await LoadPendingTasks();
    }
}
